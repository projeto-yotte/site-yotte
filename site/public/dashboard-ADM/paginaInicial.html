<!DOCTYPE html>
<html lang="BR-PT">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.8/css/line.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/visaoGeral.css">
    <link rel="stylesheet" href="../css/paginaInicial.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/cadastroADM.js"></script>
    <script src="../js/logins.js"></script>
    <title>Página Inicial</title>
</head>

<body>
    <!-- PAG MENU -->
    <div class="container">

        <div class="lateral">
            <!-- parte de cima -->
            <div class="listaBaixo">
                <div class="navegacão">

                    <div class="navHeader">
                        <img src="../assets/img/logo.png">
                    </div>
                    <ul>
                        <li class="lista destaque">
                            <a href="">
                                <i class="uil uil-create-dashboard destaque"></i>
                                <span class="lista">Página inical</span>
                            </a>
                        </li>
                        <!-- <li class="lista ">
                            <a href="VisaoGeral.html">
                                <i class="bi bi-graph-up "></i>
                                <i class="bi bi-bar-chart"></i>
                                <span class="lista">Geral</span>
                            </a>
                        </li> -->
                        <li class="lista">
                            <a href="cadastrarUser.html">
                                <i class="bi bi-person-plus-fill"></i>
                                <!-- <i class="bi bi-file-earmark-text"></i> -->
                                <span class="lista">Usuários</span>
                            </a>
                        </li>
                        <li class="lista">
                            <a href="telaLogs.html">
                                <i class="bi bi-clock-history"></i>
                                <!-- <i class="bi bi-gear"></i> -->
                                <span class="lista">Tela de Logs</span>
                            </a>
                        </li>
                        <li class="lista">
                            <a href="" onclick="EncerrarSession()">
                                <i class="bi bi-box-arrow-right"></i>
                                <!-- <i class="bi bi-gear"></i> -->
                                <span class="lista">Sair</span>
                            </a>
                        </li>
                    </ul>
                </div>

            </div>

        </div>
        <!-- FIM DO MENU -->

        <div class="areaDash">

            <div class="topDash">
                <span>Página Inicial</span>
                <div class="nomeNome">
                    <a href="../login.html">
                        <!-- <i class="uil uil-signout"></i> -->
                    </a>

                    <ul class="ul2">
                        <span class="loginUsuario" id="loginUsuario">Nome</span>
                    </ul>
                </div>

            </div>

            <div class="chats-group">
                <div class="container-chart">
                    <span>Usuários Ativos e Inativos</span>
                    <div class="chart">
                        <canvas id="myChart"></canvas>
                    </div>
                </div>

                <div class="KPI">
                    <div class="containerKpi">
                        <span>Colaboradores fora do espediente</span>
                        <div class="caixa">
                            <span class="info" id="nomeMaquina">Maquina YH - 62023</span>
                            <span class="span">Visto por ultimo: <span class="info destaque" id="hora_captura"> h/
                                    ultima captura</span></span>
                            <span class="span">Horas fora do expediente <span class="info destaque" id="hora_captura">
                                    h/</span></span>
                        </div>
                        <div class="caixa">
                            <span class="info" id="nomeMaquina">Maquina YH - 72124
                            </span>
                            <span class="span">Visto por ultimo: <span class="info destaque" id="hora_captura"> h/
                                    ultima captura</span></span>
                            <span class="span">Horas fora do expediente <span class="info destaque" id="hora_captura">
                                    h/</span></span>
                        </div>
                        <div class="caixa">
                            <span class="info" id="nomeMaquina">Maquina YH - 82225
                            </span>
                            <span class="span">Visto por ultimo: <span class="info destaque" id="hora_captura"> h/
                                    ultima captura</span></span>
                            <span class="span">Horas fora do expediente <span class="info destaque" id="hora_captura">
                                    h/</span></span>
                        </div>
                        <div class="caixa">
                            <span class="info" id="nomeMaquina">Maquina YH - 92326
                            </span>
                            <span class="span">Visto por ultimo: <span class="info destaque" id="hora_captura"> h/
                                    ultima captura</span></span>
                            <span class="span">Horas fora do expediente <span class="info destaque" id="hora_captura">
                                    h/ ultima captura</span></span>
                        </div>
                    </div>

                    <!-- <div class="containerKpi2">
                        <span>Janelas usuários</span>
                        <span>Goolgle <span id="infoCpu">10% CPU</span><span id="infoRam"> 2% RAM</span></span>
                        <span id="qtdProcessos" class="qtdProcessos">10 <span
                                class="qtdProcessos">processos</span></span>
                        <span>Goolgle <span id="infoCpu">10% CPU</span><span id="infoRam"> 2% RAM</span></span>
                        <span id="qtdProcessos" class="qtdProcessos">10 <span
                                class="qtdProcessos">processos</span></span>
                    </div> -->
                </div>

                <div class="containerBarHorizont">
                    <div class="containerGraphi">
                        <span>Relatório de problemas</span>
                        <span class="littleInfo">De acordo com hardware</span>
                        <div class="chart2">
                            <canvas id="myChart2"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chart-bottom">
                <!-- <div class="listaMaquinas">
                    <Span class="titleMaquina">Lista de Máquinas Cadastradas</Span>
                    <a href="dashEspecifica.html">
                        <div class="containerColTittle">
                            <span>Hostname: <span id="idMaquina">Maquina YH - 62023</span></span>
                            <span id="regiao">SP, Brasil</span>
                        </div>
                    </a> -->
                <!-- PRÓXIMA DIV ESTÁ SENDO PREENCHIDA PELO BANCO -->
                <div class="listaMaquinas">
                    <Span class="titleMaquina">Lista de Máquinas Cadastradas</Span>
                    <div class="topLista">
                        <span class="fontRed">Nome do Funcionário</span>
                        <span class="fontRed">Ip</span>
                    </div>
                    <div id="listaMaquinas" class="infoLista"></div>
                </div>
                <div class="containerBarHorizontal">
                    <div class="containerGraphi2">
                        <span>Tempo de inatividade<span class="littleInfo">(últimos 7 dias)</span></span>

                        <span class="littleInfo">Em horas</span>
                        <div class="chart1">
                            <canvas id="myChart3"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>

</body>

</html>

<script>
    console.log(sessionStorage.ID_USUARIO)



    // const ctx = document.getElementById('myChart');

    // new Chart(ctx, {
    //     type: 'bar',
    //     data: {
    //         labels: ['Disco', 'Ram', 'Cpu'],
    //         datasets: [{
    //             label: '# of Votes',
    //             data: [60, 60, 30],
    //             backgroundColor: ['rgba(227, 40, 50)', 'rgba(146, 19, 26)', 'rgba(78, 10, 14)'],
    //             borderWidth: 1
    //         }]
    //     },
    //     options: {
    //         scales: {
    //             y: {
    //                 beginAtZero: true
    //             }
    //         }
    //     }
    // });


    const ctxx = document.getElementById('myChart2');

    // const ctxxx = document.getElementById('myChart3');

    // new Chart(ctxxx, {
    //     type: 'bar',
    //     data: {
    //         labels: ['Maquina YH 212', 'Maquina YH 255', 'Maquina B2B 584'],
    //         datasets: [{
    //             axis: 'y',
    //             label: 'Maquina',
    //             data: [12, 8, 24],
    //             backgroundColor: ['rgba(227, 40, 50)', 'rgba(146, 19, 26)', 'rgba(78, 10, 14)'],
    //             borderWidth: 1
    //         }]
    //     },
    //     options: {
    //         indexAxis: 'y',
    //         scales: {
    //             y: {
    //                 beginAtZero: true,
    //             }
    //         }
    //     }
    // });


    window.addEventListener("load", () => {
        listarMaquinas(sessionStorage.ID_USUARIO);
        obterDadosGraficoInativos();
        foraDoEspediente();
        obterDadosGrafico();
    });


    function listarMaquinas(id_admin) {
        fetch(`/maquina/maquinas/${id_admin}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Erro ao buscar máquinas');
        }).then(function (maquinas) {
            
            const maquinasContainer = document.getElementById('listaMaquinas');

            // Limpa o conteúdo antes de adicionar as máquinas
            maquinasContainer.innerHTML = '';

            maquinas.forEach(maquina => {
                console.log("maquina: " + maquina.nome_usuario);

                const maquinaElement = document.createElement('div');
                maquinaElement.innerHTML = `
                    <div onclick="passarIdFuncionario(${maquina.id_funcionario})">
                        <div class="containerColTittle">
                            <span id="${maquina.id_funcionario}">${maquina.funcionario}</span>
                            <span id="${maquina.id_maquina}">${maquina.ip}</span>
                        </div>
                    </div>
                `;

                maquinasContainer.appendChild(maquinaElement); // Adiciona a maquinaElement ao container de maquinas
            });
        }).catch(function (error) {
            console.error('Erro ao buscar máquinas:', error);
        });
    }


    function passarIdFuncionario(idFuncionario) {
        sessionStorage.removeItem('ID_FUNCIONARIO');
        sessionStorage.setItem('ID_FUNCIONARIO', idFuncionario);

        setTimeout(function () {
            window.location = './dashEspecifica.html'
            
        }, 1000); // apenas para exibir o loading
    }

</script>



<script>
    // const ctx = document.getElementById('myChart');

    // new Chart(ctx, {
    //     type: 'doughnut',
    //     data: {
    //         labels: ['Ativos', 'Inativos'],
            
    //     },

    // });


    function obterDadosGraficoInativos(id_empresa) {

        fetch(`/dashInicial/ativosInativos/${sessionStorage.ID_EMPRESA}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    plotarGraficoNativosInativos(resposta, id_empresa);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }


    function plotarGraficoNativosInativos(resposta, id_empresa) {
        console.log(JSON.stringify(resposta))
        console.log('iniciando plotagem do gráfico...');
        
        let labels = [];
        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: ['Ativos', 'Inativos'],
            datasets: [{
                label: [],
                data: [],
                fill: false,
                borderColor: 'rgba(227, 40, 0)',
                backgroundColor: 'rgba(227, 40, 50)',
                tension: 0.1
            }]
        };

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            dados.datasets[0].data.push(registro.count_ligadas);
            dados.datasets[0].data.push(registro.count_desligadas);
            console.log(resposta)
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {   
        type: 'pie',
            data: dados,
            options: {
                scales: {
                    y: {
                        reverse: true, // Inverte a direção do eixo X
                        beginAtZero: true
                    }
                }
            }
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChart`),
            config
        );


        setTimeout(() => atualizarGraficoNativosInativos(id_empresa, dados, myChart), 2000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    

       function atualizarGraficoNativosInativos(id_empresa, dados, myChart) {
        fetch(`/dashInicial/ativosInativos/${sessionStorage.ID_EMPRESA}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    // alertar(novoRegistro, id_empresa);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);


                        for (i = 0; i < novoRegistro.length; i++) {
                            var registro = novoRegistro[i];
                            // tirando e colocando valores no gráfico

                            dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                            dados.datasets[0].data.push(registro.count_ligadas); // incluir uma nova medida de umidade

                            dados.datasets[0].data.shift();
                            dados.datasets[0].data.push(registro.count_desligadas);
                        }

                        myChart.update();
                    

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGraficoNativosInativos(id_empresa, dados, myChart), 20000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGraficoNativosInativos(id_empresa, dados, myChart), 20000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
        }
</script>




<script>

    function foraDoEspediente() {
        fetch("/dashInicial/foraDoEspediente", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(function (response) {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Erro ao buscar maquinas');
            })
            .then(function (maquinas) {
                console.log(maquinas);
                const maquinasContainer = document.getElementById('caixaForaEspediente');

                maquinasContainer.innerHTML = ''; // Limpa o conteúdo antes de adicionar as máquinas

                maquinas.forEach(maquina => {
                    const maquinaElement = document.createElement('div');
                    maquinaElement.classList.add('caixaForaEspediente');

                    maquinaElement.innerHTML = `
                        <span>Hostname: <span id="idMaquina">${maquina.id_maquina}</span></span>
                        <span id="regiao">${maquina.foraDoEspediente}</span>
                    `;

                    maquinasContainer.appendChild(maquinaElement); // Adiciona a maquinaElement ao container de maquinas
                });
            })
            .catch(function (error) {
                console.error('Erro:', error);
            });
    }
</script>

<script>


    console.log(sessionStorage.ID_EMPRESA)






    console.log('iniciando plotagem do gráfico...');




    function obterDadosGrafico(id_empresa) {

        fetch(`/dashInicial/relatorioProblemasUltimas/${sessionStorage.ID_EMPRESA}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGraficoProblemas(resposta, id_empresa);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });


        fetch(`/dashInicial/tempoInatividadeUltimas/${sessionStorage.ID_EMPRESA}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    // console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGraficoInatividade(resposta, id_empresa);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });



    }
    function plotarGraficoInatividade(resposta, id_empresa) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = ['Máquina'];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Máquina 01',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(227, 40, 50)',
                tension: 0.1
            }, {
                label: 'Máquina 02',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(146, 19, 26)',
                tension: 0.1
            }, {
                label: 'Máquina 03',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(78, 10, 14)',
                tension: 0.1
            },]
        };

        // console.log('----------------------------------------------')
        // console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGraficoProblemas":')
        // console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            dados.datasets[i].data.push(registro.tempo_inatividade_horas);
        }

        // console.log('----------------------------------------------')
        // console.log('O gráfico será plotado com os respectivos valores:')
        // console.log('Labels:')
        // console.log(labels)
        // console.log('Dados:')
        // console.log(dados.datasets)
        // console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
            options: {
                scales: {
                    y: {
                        reverse: true, // Inverte a direção do eixo X
                        beginAtZero: true
                    }
                }
            }

        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById('myChart3'),

            config
        );
        setTimeout(() => atualizarGraficoInatividade(id_empresa, dados, myChart), 2000);
    }

    function atualizarGraficoInatividade(id_empresa, dados, myChart) {

        fetch(`/dashInicial/tempoInatividadeUltimas/${sessionStorage.ID_EMPRESA}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    // alertar(novoRegistro, id_empresa);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);


                    for (i = 0; i < novoRegistro.length; i++) {
                        var registro = novoRegistro[i];
                        dados.datasets[i].data.push(registro.tempo_inatividade_horas);
                    }

                    // tirando e colocando valores no grá

                    dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                    dados.datasets[0].data.push(); // incluir uma nova medida de umidade

                    dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                    dados.datasets[1].data.push(novoRegistro[0].total_alerta_ram); // incluir uma nova medida de temperatura


                    dados.datasets[2].data.shift();  // apagar o primeiro de temperatura
                    dados.datasets[2].data.push(novoRegistro[0].total_alerta_disco); // incluir uma nova medida de temperatura


                    myChart.update();

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGraficoInatividade(id_empresa, dados, myChart), 100000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGraficoInatividade(id_empresa, dados, myChart), 100000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function plotarGraficoProblemas(resposta, id_empresa) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = ['Componentes'];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'CPU',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(227, 40, 50, 0.8)',
                tension: 0.1
            },
            {
                label: 'RAM',
                data: [],
                fill: false,
                borderColor: 'rgb(199, 52, 52)',
                backgroundColor: 'rgba(227, 40, 50, 0.8)',
                tension: 0.1
            },
            {
                label: 'DISCO',
                data: [],
                fill: false,
                borderColor: 'rgb(199, 52, 52)',
                backgroundColor: 'rgba(227, 40, 50, 0.8)',
                tension: 0.1
            }]
        };

        // console.log('----------------------------------------------')
        // console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGraficoProblemas":')
        // console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            dados.datasets[0].data.push(registro.total_alerta_cpu);
            dados.datasets[1].data.push(registro.total_alerta_ram);
            dados.datasets[2].data.push(registro.total_alerta_disco);
        }
        /*/

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')*/


        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById('myChart2'),
            config
        );
        setTimeout(() => atualizarGraficoRelatorioProblemas(id_empresa, dados, myChart), 2000);
    }

    function atualizarGraficoRelatorioProblemas(id_empresa, dados, myChart) {

        fetch(`/dashInicial/relatorioProblemasUltimas/${sessionStorage.ID_EMPRESA}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    /* alertar(novoRegistro, id_empresa);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);*/




                    // tirando e colocando valores no grá

                    dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                    dados.datasets[0].data.push(novoRegistro[0].total_alerta_cpu); // incluir uma nova medida de umidade

                    dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                    dados.datasets[1].data.push(novoRegistro[0].total_alerta_ram); // incluir uma nova medida de temperatura


                    dados.datasets[2].data.shift();  // apagar o primeiro de temperatura
                    dados.datasets[2].data.push(novoRegistro[0].total_alerta_disco); // incluir uma nova medida de temperatura


                    myChart.update();

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGraficoRelatorioProblemas(id_empresa, dados, myChart), 10000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGraficoRelatorioProblemas(id_empresa, dados, myChart), 10000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

</script>